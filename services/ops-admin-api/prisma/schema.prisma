// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// 1. USERS
// =============================================================================
model User {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  identity        String    @unique
  displayName     String?   @map("display_name")
  userType        String?   @map("user_type")  // 'guardian' | 'ward' | null
  email           String?   @unique
  nickname        String?
  profileImageUrl String?   @map("profile_image_url")
  kakaoId         String?   @unique @map("kakao_id")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  devices              Device[]
  guardian             Guardian?
  ward                 Ward?
  roomMembers          RoomMember[]
  callerCalls          Call[]              @relation("CallerCalls")
  calleeCalls          Call[]              @relation("CalleeCalls")
  notificationSettings NotificationSettings?
  refreshTokens        RefreshToken[]
  resolvedEmergencies  Emergency[]         @relation("ResolvedBy")

  @@index([email])
  @@index([kakaoId])
  @@index([userType])
  @@map("users")
}

// =============================================================================
// 2. DEVICES
// =============================================================================
model Device {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String?  @map("user_id") @db.Uuid
  platform        String
  apnsToken       String?  @unique @map("apns_token")
  voipToken       String?  @unique @map("voip_token")
  supportsCallkit Boolean  @default(true) @map("supports_callkit")
  env             String   @default("prod")
  lastSeen        DateTime @default(now()) @map("last_seen")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([env])
  @@map("devices")
}

// =============================================================================
// 3. ORGANIZATIONS
// =============================================================================
model Organization {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  wards             Ward[]
  organizationWards OrganizationWard[]
  admins            Admin[]

  @@map("organizations")
}

// =============================================================================
// 4. GUARDIANS
// =============================================================================
model Guardian {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @unique @map("user_id") @db.Uuid
  wardEmail       String   @map("ward_email")
  wardPhoneNumber String   @map("ward_phone_number")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  user                      User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  wards                     Ward[]
  healthAlerts              HealthAlert[]
  guardianWardRegistrations GuardianWardRegistration[]

  @@index([userId])
  @@index([wardEmail])
  @@map("guardians")
}

// =============================================================================
// 5. WARDS
// =============================================================================
model Ward {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId              String   @unique @map("user_id") @db.Uuid
  phoneNumber         String   @map("phone_number")
  guardianId          String?  @map("guardian_id") @db.Uuid
  organizationId      String?  @map("organization_id") @db.Uuid
  aiPersona           String?  @default("다미") @map("ai_persona")
  weeklyCallCount     Int      @default(3) @map("weekly_call_count")
  callDurationMinutes Int      @default(15) @map("call_duration_minutes")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  user                      User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  guardian                  Guardian?                  @relation(fields: [guardianId], references: [id], onDelete: SetNull)
  organization              Organization?              @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  callSummaries             CallSummary[]
  healthAlerts              HealthAlert[]
  callSchedules             CallSchedule[]
  organizationWards         OrganizationWard[]
  wardLocations             WardLocation[]
  wardCurrentLocation       WardCurrentLocation?
  emergencies               Emergency[]
  guardianWardRegistrations GuardianWardRegistration[]

  @@index([userId])
  @@index([guardianId])
  @@index([organizationId])
  @@map("wards")
}

// =============================================================================
// 6. ROOMS
// =============================================================================
model Room {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  roomName  String   @unique @map("room_name")
  meta      Json?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  members RoomMember[]

  @@map("rooms")
}

// =============================================================================
// 7. CALLS
// =============================================================================
model Call {
  callId         String    @id @default(dbgenerated("gen_random_uuid()")) @map("call_id") @db.Uuid
  callerUserId   String?   @map("caller_user_id") @db.Uuid
  calleeUserId   String?   @map("callee_user_id") @db.Uuid
  callerIdentity String    @map("caller_identity")
  calleeIdentity String    @map("callee_identity")
  roomName       String    @map("room_name")
  state          String    @default("ringing")
  createdAt      DateTime  @default(now()) @map("created_at")
  answeredAt     DateTime? @map("answered_at")
  endedAt        DateTime? @map("ended_at")

  // Relations
  caller      User?         @relation("CallerCalls", fields: [callerUserId], references: [id], onDelete: SetNull)
  callee      User?         @relation("CalleeCalls", fields: [calleeUserId], references: [id], onDelete: SetNull)
  callSummary CallSummary[]

  @@index([calleeIdentity, state])
  @@index([roomName])
  @@map("calls")
}

// =============================================================================
// 8. ROOM_MEMBERS
// =============================================================================
model RoomMember {
  id       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  roomId   String   @map("room_id") @db.Uuid
  userId   String   @map("user_id") @db.Uuid
  role     String   @default("viewer")
  joinedAt DateTime @default(now()) @map("joined_at")

  // Relations
  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([roomId])
  @@map("room_members")
}

// =============================================================================
// 9. CALL_SUMMARIES
// =============================================================================
model CallSummary {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  callId         String   @map("call_id") @db.Uuid
  wardId         String   @map("ward_id") @db.Uuid
  summary        String?
  mood           String?  // 'positive' | 'neutral' | 'negative'
  moodScore      Decimal? @map("mood_score") @db.Decimal(3, 2)
  tags           String[]
  healthKeywords Json?    @map("health_keywords")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  call Call @relation(fields: [callId], references: [callId], onDelete: Cascade)
  ward Ward @relation(fields: [wardId], references: [id], onDelete: Cascade)

  @@index([callId])
  @@index([wardId])
  @@index([createdAt])
  @@map("call_summaries")
}

// =============================================================================
// 10. HEALTH_ALERTS
// =============================================================================
model HealthAlert {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  wardId     String   @map("ward_id") @db.Uuid
  guardianId String   @map("guardian_id") @db.Uuid
  alertType  String   @map("alert_type") // 'warning' | 'info'
  message    String
  isRead     Boolean  @default(false) @map("is_read")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  ward     Ward     @relation(fields: [wardId], references: [id], onDelete: Cascade)
  guardian Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)

  @@index([guardianId])
  @@index([wardId])
  @@index([isRead])
  @@map("health_alerts")
}

// =============================================================================
// 11. NOTIFICATION_SETTINGS
// =============================================================================
model NotificationSettings {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @unique @map("user_id") @db.Uuid
  callReminder Boolean  @default(true) @map("call_reminder")
  callComplete Boolean  @default(true) @map("call_complete")
  healthAlert  Boolean  @default(true) @map("health_alert")
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notification_settings")
}

// =============================================================================
// 12. REFRESH_TOKENS
// =============================================================================
model RefreshToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

// =============================================================================
// 13. GUARDIAN_WARD_REGISTRATIONS
// =============================================================================
model GuardianWardRegistration {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  guardianId      String   @map("guardian_id") @db.Uuid
  wardEmail       String   @map("ward_email")
  wardPhoneNumber String   @map("ward_phone_number")
  linkedWardId    String?  @map("linked_ward_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  guardian   Guardian @relation(fields: [guardianId], references: [id], onDelete: Cascade)
  linkedWard Ward?    @relation(fields: [linkedWardId], references: [id], onDelete: SetNull)

  @@index([guardianId])
  @@index([wardEmail])
  @@index([linkedWardId])
  @@map("guardian_ward_registrations")
}

// =============================================================================
// 14. CALL_SCHEDULES
// =============================================================================
model CallSchedule {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  wardId         String    @map("ward_id") @db.Uuid
  dayOfWeek      Int       @map("day_of_week") // 0=일, 1=월, ..., 6=토
  scheduledTime  DateTime  @map("scheduled_time") @db.Time
  isActive       Boolean   @default(true) @map("is_active")
  lastCalledAt   DateTime? @map("last_called_at")
  reminderSentAt DateTime? @map("reminder_sent_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  ward Ward @relation(fields: [wardId], references: [id], onDelete: Cascade)

  @@index([wardId])
  @@index([dayOfWeek])
  @@index([isActive])
  @@map("call_schedules")
}

// =============================================================================
// 15. ORGANIZATION_WARDS
// =============================================================================
model OrganizationWard {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId    String    @map("organization_id") @db.Uuid
  uploadedByAdminId String?   @map("uploaded_by_admin_id") @db.Uuid
  email             String
  phoneNumber       String    @map("phone_number")
  name              String
  birthDate         DateTime? @map("birth_date") @db.Date
  address           String?
  notes             String?
  isRegistered      Boolean   @default(false) @map("is_registered")
  wardId            String?   @map("ward_id") @db.Uuid
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploadedByAdmin Admin?       @relation(fields: [uploadedByAdminId], references: [id], onDelete: SetNull)
  ward            Ward?        @relation(fields: [wardId], references: [id], onDelete: SetNull)

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
  @@index([isRegistered])
  @@index([uploadedByAdminId])
  @@map("organization_wards")
}

// =============================================================================
// 16. WARD_LOCATIONS
// =============================================================================
model WardLocation {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  wardId     String   @map("ward_id") @db.Uuid
  latitude   Decimal  @db.Decimal(10, 8)
  longitude  Decimal  @db.Decimal(11, 8)
  accuracy   Decimal? @db.Decimal(6, 2)
  recordedAt DateTime @map("recorded_at")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  ward Ward @relation(fields: [wardId], references: [id], onDelete: Cascade)

  @@index([wardId])
  @@index([recordedAt])
  @@index([wardId, recordedAt(sort: Desc)])
  @@map("ward_locations")
}

// =============================================================================
// 17. WARD_CURRENT_LOCATIONS
// =============================================================================
model WardCurrentLocation {
  wardId      String   @id @map("ward_id") @db.Uuid
  latitude    Decimal  @db.Decimal(10, 8)
  longitude   Decimal  @db.Decimal(11, 8)
  accuracy    Decimal? @db.Decimal(6, 2)
  status      String   @default("normal") // 'normal' | 'warning' | 'emergency'
  lastUpdated DateTime @map("last_updated")

  // Relations
  ward Ward @relation(fields: [wardId], references: [id], onDelete: Cascade)

  @@index([status])
  @@map("ward_current_locations")
}

// =============================================================================
// 18. EMERGENCY_AGENCIES
// =============================================================================
model EmergencyAgency {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  type        String   // 'fire_station' | 'police' | 'hospital' | 'welfare_center'
  phoneNumber String   @map("phone_number")
  latitude    Decimal  @db.Decimal(10, 8)
  longitude   Decimal  @db.Decimal(11, 8)
  address     String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  emergencyContacts EmergencyContact[]

  @@index([type])
  @@index([isActive])
  @@map("emergency_agencies")
}

// =============================================================================
// 19. EMERGENCIES
// =============================================================================
model Emergency {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  wardId           String?   @map("ward_id") @db.Uuid
  type             String    // 'manual' | 'ai_detected' | 'geofence' | 'admin'
  status           String    @default("active") // 'active' | 'resolved' | 'false_alarm'
  latitude         Decimal?  @db.Decimal(10, 8)
  longitude        Decimal?  @db.Decimal(11, 8)
  message          String?
  guardianNotified Boolean   @default(false) @map("guardian_notified")
  resolvedAt       DateTime? @map("resolved_at")
  resolvedById     String?   @map("resolved_by") @db.Uuid
  resolutionNote   String?   @map("resolution_note")
  createdAt        DateTime  @default(now()) @map("created_at")

  // Relations
  ward              Ward?              @relation(fields: [wardId], references: [id], onDelete: SetNull)
  resolvedBy        User?              @relation("ResolvedBy", fields: [resolvedById], references: [id], onDelete: SetNull)
  emergencyContacts EmergencyContact[]

  @@index([wardId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("emergencies")
}

// =============================================================================
// 20. EMERGENCY_CONTACTS
// =============================================================================
model EmergencyContact {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  emergencyId    String   @map("emergency_id") @db.Uuid
  agencyId       String?  @map("agency_id") @db.Uuid
  distanceKm     Decimal? @map("distance_km") @db.Decimal(6, 2)
  contactedAt    DateTime @default(now()) @map("contacted_at")
  responseStatus String   @default("pending") @map("response_status") // 'pending' | 'answered' | 'dispatched' | 'failed'

  // Relations
  emergency Emergency        @relation(fields: [emergencyId], references: [id], onDelete: Cascade)
  agency    EmergencyAgency? @relation(fields: [agencyId], references: [id], onDelete: SetNull)

  @@index([emergencyId])
  @@index([agencyId])
  @@map("emergency_contacts")
}

// =============================================================================
// 21. ADMINS
// =============================================================================
model Admin {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email          String    @unique
  name           String?
  provider       String    // 'kakao' | 'google'
  providerId     String    @map("provider_id")
  role           String    @default("viewer") // 'super_admin' | 'org_admin' | 'viewer'
  organizationId String?   @map("organization_id") @db.Uuid
  isActive       Boolean   @default(true) @map("is_active")
  lastLoginAt    DateTime? @map("last_login_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  organization      Organization?       @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  permissions       AdminPermission[]
  refreshTokens     AdminRefreshToken[]
  uploadedWards     OrganizationWard[]

  @@unique([provider, providerId])
  @@index([email])
  @@index([provider, providerId])
  @@index([role])
  @@index([organizationId])
  @@map("admins")
}

// =============================================================================
// 22. ADMIN_PERMISSIONS
// =============================================================================
model AdminPermission {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  adminId    String   @map("admin_id") @db.Uuid
  permission String   // 'dashboard:read' | 'wards:write' | 'emergency:manage' etc.
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@unique([adminId, permission])
  @@index([adminId])
  @@map("admin_permissions")
}

// =============================================================================
// 23. ADMIN_REFRESH_TOKENS
// =============================================================================
model AdminRefreshToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  adminId   String   @map("admin_id") @db.Uuid
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([tokenHash])
  @@map("admin_refresh_tokens")
}
